-- Mostrar usuario actual
SHOW USER;

-- Creación de roles y asignación de privilegios

-- Rol para desarrolladores
CREATE ROLE ROL_DEV_SISTEMA_BANCARIO;

-- Otorgar privilegios al rol ROL_DEV_SISTEMA_BANCARIO
GRANT SELECT ON MDY2131_P13_1.V_TOTAL_CREDITOS_CLIENTES_ANUAL TO ROL_DEV_SISTEMA_BANCARIO;
GRANT SELECT ON MDY2131_P13_1.V_CLIENTES_PROD_INV TO ROL_DEV_SISTEMA_BANCARIO;
GRANT SELECT ON MDY2131_P13_1.V_CLIENTES_CUMPLEANOS TO ROL_DEV_SISTEMA_BANCARIO;
GRANT SELECT ON MDY2131_P13_1.V_CLIENTES_CREDITOS_MAYORES TO ROL_DEV_SISTEMA_BANCARIO;
GRANT SELECT ON MDY2131_P13_1.V_CLIENTES_SII_INV TO ROL_DEV_SISTEMA_BANCARIO;

GRANT INSERT, UPDATE, DELETE ON CREDITO_CLIENTE TO ROL_DEV_SISTEMA_BANCARIO;
GRANT INSERT, UPDATE, DELETE ON PRODUCTO_INVERSION_CLIENTE TO ROL_DEV_SISTEMA_BANCARIO;
GRANT INSERT, UPDATE, DELETE ON CUOTA_CREDITO_CLIENTE TO ROL_DEV_SISTEMA_BANCARIO;

GRANT CREATE PROCEDURE TO ROL_DEV_SISTEMA_BANCARIO;
GRANT CREATE TRIGGER TO ROL_DEV_SISTEMA_BANCARIO;
GRANT CREATE VIEW TO ROL_DEV_SISTEMA_BANCARIO;
GRANT CREATE MATERIALIZED VIEW TO ROL_DEV_SISTEMA_BANCARIO;

GRANT ROL_DEV_SISTEMA_BANCARIO TO MDY2131_P13_2;
GRANT ROL_DEV_SISTEMA_BANCARIO TO MDY2131_P13_3;

-- Rol para informes de clientes
CREATE ROLE ROL_INF_CLIENTES_KOPERA;

-- Otorgar privilegios al rol ROL_INF_CLIENTES_KOPERA
GRANT SELECT ON MDY2131_P13_1.V_TOTAL_CREDITOS_CLIENTES_ANUAL TO ROL_INF_CLIENTES_KOPERA;
GRANT SELECT ON MDY2131_P13_1.V_CLIENTES_CUMPLEANOS TO ROL_INF_CLIENTES_KOPERA;
GRANT SELECT ON MDY2131_P13_1.V_CLIENTES_SII_INV TO ROL_INF_CLIENTES_KOPERA;

GRANT SELECT ON MDY2131_P13_3.syn_cliente TO ROL_INF_CLIENTES_KOPERA;
GRANT SELECT ON MDY2131_P13_3.syn_region TO ROL_INF_CLIENTES_KOPERA;
GRANT SELECT ON MDY2131_P13_3.syn_provincia TO ROL_INF_CLIENTES_KOPERA;
GRANT SELECT ON MDY2131_P13_3.syn_comuna TO ROL_INF_CLIENTES_KOPERA;

GRANT ROL_INF_CLIENTES_KOPERA TO MDY2131_P13_5;
GRANT ROL_INF_CLIENTES_KOPERA TO MDY2131_P13_6;

-- Creación y configuración de usuarios

-- Usuario MDY2131_P13_1
CREATE USER MDY2131_P13_1 IDENTIFIED BY "CDB.semana_8_1"
  DEFAULT TABLESPACE USERS
  TEMPORARY TABLESPACE TEMP
  QUOTA UNLIMITED ON USERS
  PROFILE DEFAULT
  ACCOUNT UNLOCK;

ALTER PROFILE DEFAULT LIMIT
  FAILED_LOGIN_ATTEMPTS 10
  PASSWORD_LIFE_TIME 120
  PASSWORD_VERIFY_FUNCTION verify_function;

GRANT CREATE SESSION TO MDY2131_P13_1;
GRANT CREATE VIEW TO MDY2131_P13_1;
GRANT CREATE TABLE TO MDY2131_P13_1;
GRANT ALTER ANY TABLE TO MDY2131_P13_1;
GRANT CREATE INDEX TO MDY2131_P13_1;
GRANT DROP ANY TABLE TO MDY2131_P13_1;
GRANT CREATE SEQUENCE TO MDY2131_P13_1;
GRANT CREATE ANY INDEX TO MDY2131_P13_1;
GRANT CREATE SYNONYM TO MDY2131_P13_1;
GRANT SELECT ON PRODUCTO_INVERSION_CLIENTE TO MDY2131_P13_1;
GRANT SELECT ON CLIENTE TO MDY2131_P13_1;
GRANT CREATE ANY INDEX TO MDY2131_P13_1;
GRANT EXECUTE ON DBMS_STATS TO MDY2131_P13_1;
GRANT ANALYZE ANY DICTIONARY TO MDY2131_P13_1;

-- Creación de sinónimos
CREATE OR REPLACE PUBLIC SYNONYM V_TOTAL_CREDITOS_CLIENTES_ANUAL FOR MDY2131_P13_1.V_TOTAL_CREDITOS_CLIENTES_ANUAL;
CREATE OR REPLACE PUBLIC SYNONYM V_CLIENTES_PROD_INV FOR MDY2131_P13_1.V_CLIENTES_PROD_INV;
CREATE OR REPLACE PUBLIC SYNONYM V_CLIENTES_CUMPLEANOS FOR MDY2131_P13_1.V_CLIENTES_CUMPLEANOS;
CREATE OR REPLACE PUBLIC SYNONYM V_CLIENTES_CREDITOS_MAYORES FOR MDY2131_P13_1.V_CLIENTES_CREDITOS_MAYORES;
CREATE OR REPLACE PUBLIC SYNONYM V_CLIENTES_SII_INV FOR MDY2131_P13_1.V_CLIENTES_SII_INV;

-- Usuario MDY2131_P13_2
CREATE USER MDY2131_P13_2 IDENTIFIED BY "CDB.semana_8_2"
  DEFAULT TABLESPACE DATA
  TEMPORARY TABLESPACE TEMP
  QUOTA UNLIMITED ON DATA
  PROFILE DEFAULT
  ACCOUNT UNLOCK;

ALTER PROFILE DEFAULT LIMIT
  SESSIONS_PER_USER 4
  IDLE_TIME 60
  FAILED_LOGIN_ATTEMPTS 5
  PASSWORD_LOCK_TIME 1440
  PASSWORD_LIFE_TIME 90
  PASSWORD_VERIFY_FUNCTION verify_function;

GRANT CREATE SESSION TO MDY2131_P13_2;
GRANT SELECT ANY TABLE TO MDY2131_P13_2;
GRANT INSERT ANY TABLE TO MDY2131_P13_2;
GRANT UPDATE ANY TABLE TO MDY2131_P13_2;
GRANT DELETE ANY TABLE TO MDY2131_P13_2;
GRANT CREATE VIEW TO MDY2131_P13_2;
GRANT CREATE SYNONYM TO MDY2131_P13_2;

CREATE SYNONYM MDY2131_P13_2.syn_credito_cliente FOR MDY2131_P13_1.CREDITO_CLIENTE;
CREATE SYNONYM MDY2131_P13_2.syn_producto_inversion_cliente FOR MDY2131_P13_1.PRODUCTO_INVERSION_CLIENTE;
CREATE SYNONYM MDY2131_P13_2.syn_cuota_credito_cliente FOR MDY2131_P13_1.CUOTA_CREDITO_CLIENTE;
CREATE SYNONYM MDY2131_P13_2.syn_aporte_a_sbif FOR MDY2131_P13_1.APORTE_A_SBIF;
CREATE SYNONYM MDY2131_P13_2.syn_producto_inversion FOR MDY2131_P13_1.PRODUCTO_INVERSION;
CREATE SYNONYM MDY2131_P13_2.syn_credito FOR MDY2131_P13_1.CREDITO;
CREATE SYNONYM MDY2131_P13_2.syn_tipo_contrato FOR MDY2131_P13_1.TIPO_CONTRATO;
CREATE SYNONYM MDY2131_P13_2.syn_region FOR MDY2131_P13_1.REGION;
CREATE SYNONYM MDY2131_P13_2.syn_provincia FOR MDY2131_P13_1.PROVINCIA;
CREATE SYNONYM MDY2131_P13_2.syn_comuna FOR MDY2131_P13_1.COMUNA;
CREATE SYNONYM MDY2131_P13_2.syn_sucursal FOR MDY2131_P13_1.SUCURSAL;
CREATE SYNONYM MDY2131_P13_2.syn_profesion_oficio FOR MDY2131_P13_1.PROFESION_OFICIO;
CREATE SYNONYM MDY2131_P13_2.syn_tipo_movimiento FOR MDY2131_P13_1.TIPO_MOVIMIENTO;
CREATE SYNONYM MDY2131_P13_2.syn_forma_pago FOR MDY2131_P13_1.FORMA_PAGO;
CREATE SYNONYM MDY2131_P13_2.syn_cliente FOR MDY2131_P13_1.CLIENTE;
CREATE SYNONYM MDY2131_P13_2.syn_movimiento FOR MDY2131_P13_1.MOVIMIENTO;
CREATE OR REPLACE SYNONYM MDY2131_P13_2.SYN_VISTA_CLIENTES_CUMPLEANOS FOR MDY2131_P13_1.VISTA_CLIENTES_CUMPLEANOS;

-- Usuario MDY2131_P13_3
CREATE USER MDY2131_P13_3 IDENTIFIED BY "CDB.semana_8_3"
  DEFAULT TABLESPACE DATA
  TEMPORARY TABLESPACE TEMP
  QUOTA UNLIMITED ON DATA
  PROFILE DEFAULT
  ACCOUNT UNLOCK;

ALTER PROFILE DEFAULT LIMIT
  SESSIONS_PER_USER 4
  IDLE_TIME 60
  FAILED_LOGIN_ATTEMPTS 5
  PASSWORD_LOCK_TIME 1440
  PASSWORD_LIFE_TIME 90
  PASSWORD_VERIFY_FUNCTION verify_function;

GRANT CREATE SESSION TO MDY2131_P13_3;
GRANT CREATE VIEW TO MDY2131_P13_3;
GRANT SELECT ON MDY2131_P13_1.APORTE_A_SBIF TO MDY2131_P13_3;
GRANT INSERT, UPDATE, DELETE ON MDY2131_P13_1.CREDITO_CLIENTE TO MDY2131_P13_3;
GRANT SELECT ON MDY2131_P13_1.PRODUCTO_INVERSION TO MDY2131_P13_3;
GRANT INSERT, UPDATE, DELETE ON MDY2131_P13_1.PRODUCTO_INVERSION_CLIENTE TO MDY2131_P13_3;
GRANT SELECT ON MDY2131_P13_1.CREDITO TO MDY2131_P13_3;
GRANT INSERT, UPDATE, DELETE ON MDY2131_P13_1.CUOTA_CREDITO_CLIENTE TO MDY2131_P13_3;

CREATE SYNONYM MDY2131_P13_3.syn_credito_cliente FOR MDY2131_P13_1.CREDITO_CLIENTE;
CREATE SYNONYM MDY2131_P13_3.syn_producto_inversion_cliente FOR MDY2131_P13_1.PRODUCTO_INVERSION_CLIENTE;
CREATE SYNONYM MDY2131_P13_3.syn_cuota_credito_cliente FOR MDY2131_P13_1.CUOTA_CREDITO_CLIENTE;
CREATE SYNONYM MDY2131_P13_3.syn_aporte_a_sbif FOR MDY2131_P13_1.APORTE_A_SBIF;
CREATE SYNONYM MDY2131_P13_3.syn_producto_inversion FOR MDY2131_P13_1.PRODUCTO_INVERSION;
CREATE SYNONYM MDY2131_P13_3.syn_credito FOR MDY2131_P13_1.CREDITO;
CREATE SYNONYM MDY2131_P13_3.syn_tipo_contrato FOR MDY2131_P13_1.TIPO_CONTRATO;
CREATE SYNONYM MDY2131_P13_3.syn_region FOR MDY2131_P13_1.REGION;
CREATE SYNONYM MDY2131_P13_3.syn_provincia FOR MDY2131_P13_1.PROVINCIA;
CREATE SYNONYM MDY2131_P13_3.syn_comuna FOR MDY2131_P13_1.COMUNA;
CREATE SYNONYM MDY2131_P13_3.syn_sucursal FOR MDY2131_P13_1.SUCURSAL;
CREATE SYNONYM MDY2131_P13_3.syn_profesion_oficio FOR MDY2131_P13_1.PROFESION_OFICIO;
CREATE SYNONYM MDY2131_P13_3.syn_tipo_movimiento FOR MDY2131_P13_1.TIPO_MOVIMIENTO;
CREATE SYNONYM MDY2131_P13_3.syn_forma_pago FOR MDY2131_P13_1.FORMA_PAGO;
CREATE SYNONYM MDY2131_P13_3.syn_cliente FOR MDY2131_P13_1.CLIENTE;
CREATE SYNONYM MDY2131_P13_3.syn_movimiento FOR MDY2131_P13_1.MOVIMIENTO;
CREATE OR REPLACE SYNONYM MDY2131_P13_3.SYN_VISTA_CLIENTES_CUMPLEANOS FOR MDY2131_P13_1.VISTA_CLIENTES_CUMPLEANOS;

GRANT SELECT ON CLIENTE TO MDY2131_P13_3;
GRANT SELECT ON REGION TO MDY2131_P13_3;
GRANT SELECT ON PROVINCIA TO MDY2131_P13_3;
GRANT SELECT ON COMUNA TO MDY2131_P13_3;

CREATE SYNONYM syn_cliente FOR MDY2131_P13_1.CLIENTE;
CREATE SYNONYM syn_region FOR MDY2131_P13_1.REGION;
CREATE SYNONYM syn_provincia FOR MDY2131_P13_1.PROVINCIA;
CREATE SYNONYM syn_comuna FOR MDY2131_P13_1.COMUNA;

-- Usuario MDY2131_P13_4
CREATE USER MDY2131_P13_4 IDENTIFIED BY "CDB.semana_8_4"
  DEFAULT TABLESPACE DATA
  TEMPORARY TABLESPACE TEMP
  QUOTA UNLIMITED ON DATA
  PROFILE DEFAULT
  ACCOUNT UNLOCK;

ALTER PROFILE DEFAULT LIMIT
  SESSIONS_PER_USER 2
  IDLE_TIME 20
  FAILED_LOGIN_ATTEMPTS 2
  PASSWORD_LOCK_TIME 3600
  PASSWORD_LIFE_TIME 90
  PASSWORD_GRACE_TIME 1
  PASSWORD_VERIFY_FUNCTION verify_function;

GRANT CREATE SESSION TO MDY2131_P13_4;
GRANT SELECT ON MDY2131_P13_1.CREDITO_CLIENTE TO MDY2131_P13_4;
GRANT SELECT ON MDY2131_P13_1.PRODUCTO_INVERSION_CLIENTE TO MDY2131_P13_4;
GRANT SELECT ON MDY2131_P13_1.CUOTA_CREDITO_CLIENTE TO MDY2131_P13_4;
GRANT SELECT ON MDY2131_P13_1.TIPO_MOVIMIENTO TO MDY2131_P13_4;
GRANT SELECT ON MDY2131_P13_1.SUCURSAL TO MDY2131_P13_4;
GRANT SELECT ON MDY2131_P13_1.TIPO_CONTRATO TO MDY2131_P13_4;
GRANT SELECT ON MDY2131_P13_1.CLIENTE TO MDY2131_P13_4;
GRANT SELECT ON MDY2131_P13_1.REGION TO MDY2131_P13_4;
GRANT SELECT ON MDY2131_P13_1.PROVINCIA TO MDY2131_P13_4;
GRANT SELECT ON MDY2131_P13_1.COMUNA TO MDY2131_P13_4;

CREATE SYNONYM MDY2131_P13_4.syn_aporte_a_sbif FOR MDY2131_P13_1.APORTE_A_SBIF;
CREATE SYNONYM MDY2131_P13_4.syn_producto_inversion FOR MDY2131_P13_1.PRODUCTO_INVERSION;
CREATE SYNONYM MDY2131_P13_4.syn_credito FOR MDY2131_P13_1.CREDITO;
CREATE SYNONYM MDY2131_P13_4.syn_tipo_contrato FOR MDY2131_P13_1.TIPO_CONTRATO;
CREATE SYNONYM MDY2131_P13_4.syn_region FOR MDY2131_P13_1.REGION;
CREATE SYNONYM MDY2131_P13_4.syn_provincia FOR MDY2131_P13_1.PROVINCIA;
CREATE SYNONYM MDY2131_P13_4.syn_comuna FOR MDY2131_P13_1.COMUNA;
CREATE SYNONYM MDY2131_P13_4.syn_sucursal FOR MDY2131_P13_1.SUCURSAL;
CREATE SYNONYM MDY2131_P13_4.syn_profesion_oficio FOR MDY2131_P13_1.PROFESION_OFICIO;
CREATE SYNONYM MDY2131_P13_4.syn_tipo_movimiento FOR MDY2131_P13_1.TIPO_MOVIMIENTO;
CREATE SYNONYM MDY2131_P13_4.syn_forma_pago FOR MDY2131_P13_1.FORMA_PAGO;
CREATE SYNONYM MDY2131_P13_4.syn_cliente FOR MDY2131_P13_1.CLIENTE;
CREATE SYNONYM MDY2131_P13_4.syn_movimiento FOR MDY2131_P13_1.MOVIMIENTO;
CREATE OR REPLACE SYNONYM MDY2131_P13_4.SYN_VISTA_CLIENTES_CUMPLEANOS FOR MDY2131_P13_1.VISTA_CLIENTES_CUMPLEANOS;

-- Usuario MDY2131_P13_5
CREATE USER MDY2131_P13_5 IDENTIFIED BY "CDB.semana_8_5"
  DEFAULT TABLESPACE DATA
  TEMPORARY TABLESPACE TEMP
  QUOTA UNLIMITED ON DATA
  PROFILE DEFAULT
  ACCOUNT UNLOCK;

ALTER PROFILE DEFAULT LIMIT
  SESSIONS_PER_USER 2
  IDLE_TIME 20
  FAILED_LOGIN_ATTEMPTS 2
  PASSWORD_LOCK_TIME 3600
  PASSWORD_LIFE_TIME 90
  PASSWORD_GRACE_TIME 1
  PASSWORD_VERIFY_FUNCTION verify_function;

GRANT CREATE SESSION TO MDY2131_P13_5;
GRANT CREATE VIEW TO MDY2131_P13_5;

CREATE SYNONYM MDY2131_P13_5.syn_cliente FOR MDY2131_P13_3.syn_cliente;
CREATE SYNONYM MDY2131_P13_5.syn_region FOR MDY2131_P13_3.syn_region;
CREATE SYNONYM MDY2131_P13_5.syn_provincia FOR MDY2131_P13_3.syn_provincia;
CREATE SYNONYM MDY2131_P13_5.syn_comuna FOR MDY2131_P13_3.syn_comuna;

GRANT SELECT ON MDY2131_P13_5.syn_cliente TO MDY2131_P13_5;
GRANT SELECT ON MDY2131_P13_5.syn_region TO MDY2131_P13_5;
GRANT SELECT ON MDY2131_P13_5.syn_provincia TO MDY2131_P13_5;
GRANT SELECT ON MDY2131_P13_5.syn_comuna TO MDY2131_P13_5;

GRANT SELECT ON MDY2131_P13_1.CLIENTE TO MDY2131_P13_5;
GRANT SELECT ON MDY2131_P13_1.REGION TO MDY2131_P13_5;
GRANT SELECT ON MDY2131_P13_1.PROVINCIA TO MDY2131_P13_5;
GRANT SELECT ON MDY2131_P13_1.COMUNA TO MDY2131_P13_5;

-- Usuario MDY2131_P13_6
CREATE USER MDY2131_P13_6 IDENTIFIED BY "CDB.semana_8_6"
  DEFAULT TABLESPACE DATA
  TEMPORARY TABLESPACE TEMP
  QUOTA UNLIMITED ON DATA
  PROFILE DEFAULT
  ACCOUNT UNLOCK;

ALTER PROFILE DEFAULT LIMIT
  SESSIONS_PER_USER 2
  IDLE_TIME 20
  FAILED_LOGIN_ATTEMPTS 2
  PASSWORD_LOCK_TIME 3600
  PASSWORD_LIFE_TIME 90
  PASSWORD_GRACE_TIME 1
  PASSWORD_VERIFY_FUNCTION verify_function;

GRANT CREATE SESSION TO MDY2131_P13_6;
GRANT CREATE VIEW TO MDY2131_P13_6;

CREATE SYNONYM MDY2131_P13_6.syn_cliente FOR MDY2131_P13_3.syn_cliente;
CREATE SYNONYM MDY2131_P13_6.syn_region FOR MDY2131_P13_3.syn_region;
CREATE SYNONYM MDY2131_P13_6.syn_provincia FOR MDY2131_P13_3.syn_provincia;
CREATE SYNONYM MDY2131_P13_6.syn_comuna FOR MDY2131_P13_3.syn_comuna;

GRANT SELECT ON MDY2131_P13_6.syn_cliente TO MDY2131_P13_6;
GRANT SELECT ON MDY2131_P13_6.syn_region TO MDY2131_P13_6;
GRANT SELECT ON MDY2131_P13_6.syn_provincia TO MDY2131_P13_6;
GRANT SELECT ON MDY2131_P13_6.syn_comuna TO MDY2131_P13_6;

GRANT SELECT ON MDY2131_P13_1.CLIENTE TO MDY2131_P13_6;
GRANT SELECT ON MDY2131_P13_1.REGION TO MDY2131_P13_6;
GRANT SELECT ON MDY2131_P13_1.PROVINCIA TO MDY2131_P13_6;
GRANT SELECT ON MDY2131_P13_1.COMUNA TO MDY2131_P13_6;

CREATE OR REPLACE PUBLIC SYNONYM SYN_V_TOTAL_CREDITOS_CLIENTES_ANUAL FOR MDY2131_P13_3.V_TOTAL_CREDITOS_CLIENTES_ANUAL;
CREATE OR REPLACE PUBLIC SYNONYM SYN_V_CLIENTES_PROD_INV FOR MDY2131_P13_3.V_CLIENTES_PROD_INV;
CREATE OR REPLACE PUBLIC SYNONYM SYN_V_CLIENTES_CUMPLEANOS FOR MDY2131_P13_3.V_CLIENTES_CUMPLEANOS;
CREATE OR REPLACE PUBLIC SYNONYM SYN_V_CLIENTES_SII_INV FOR MDY2131_P13_3.V_CLIENTES_SII_INV;

------------------------USUARIO 1-------------------------------

-- Creación de vistas
CREATE OR REPLACE VIEW V_TOTAL_CREDITOS_CLIENTES_ANUAL AS
SELECT TO_CHAR(c.numrun) || '-' || UPPER(c.dvrun) AS RUN_CLIENTE,
       INITCAP(LOWER(c.pnombre)) || ' ' || INITCAP(LOWER(c.snombre)) || ' ' || INITCAP(LOWER(c.appaterno)) || ' ' || INITCAP(LOWER(c.apmaterno)) AS NOMBRE_CLIENTE,
       COUNT(cc.nro_cliente) AS TOTAL_CREDITOS_SOLICITADOS,
       TO_CHAR(SUM(cc.monto_solicitado), '$999G999G999') AS MONTO_TOTAL_CREDITO
FROM cliente c 
JOIN credito_cliente cc ON (c.nro_cliente = cc.nro_cliente)
WHERE EXTRACT(YEAR FROM cc.fecha_solic_cred) = EXTRACT(YEAR FROM SYSDATE) - 1
GROUP BY c.numrun, c.dvrun, c.pnombre, c.snombre, c.appaterno, c.apmaterno
ORDER BY c.appaterno;

CREATE OR REPLACE VIEW MDY2131_P13_1.V_CLIENTES_PROD_INV AS
SELECT nro_cliente, COUNT(*) AS total_productos_inversion
FROM PRODUCTO_INVERSION_CLIENTE
GROUP BY nro_cliente
ORDER BY total_productos_inversion DESC;

CREATE OR REPLACE VIEW MDY2131_P13_1.V_CLIENTES_CUMPLEANOS AS
SELECT nro_cliente, pnombre, appaterno, apmaterno, fecha_nacimiento
FROM CLIENTE
WHERE EXTRACT(MONTH FROM fecha_nacimiento) = EXTRACT(MONTH FROM SYSDATE)
AND EXTRACT(DAY FROM fecha_nacimiento) <= EXTRACT(DAY FROM LAST_DAY(SYSDATE));

CREATE OR REPLACE VIEW MDY2131_P13_1.V_CLIENTES_CREDITOS_MAYORES AS
SELECT cc.nro_cliente, c.pnombre, c.appaterno, c.apmaterno, cc.monto_credito
FROM CREDITO_CLIENTE cc
JOIN CLIENTE c ON cc.nro_cliente = c.nro_cliente
WHERE cc.monto_credito > (SELECT AVG(monto_credito) FROM CREDITO_CLIENTE);

CREATE OR REPLACE VIEW MDY2131_P13_1.V_CLIENTES_SII_INV AS
SELECT c.nro_cliente, c.pnombre, c.appaterno, c.apmaterno, pic.cod_prod_inv, pic.fecha_solic_prod
FROM CLIENTE c
JOIN PRODUCTO_INVERSION_CLIENTE pic ON c.nro_cliente = pic.nro_cliente
WHERE EXTRACT(YEAR FROM pic.fecha_solic_prod) = EXTRACT(YEAR FROM SYSDATE)
AND c.cod_tipo_contrato = (SELECT tc.cod_tipo_contrato FROM TIPO_CONTRATO tc WHERE tc.nombre_tipo_contrato = 'Dependiente');

-- Creación de sinónimos
CREATE OR REPLACE SYNONYM MDY2131_P13_1.SYN_V_TOTAL_CREDITOS_CLIENTES_ANUAL FOR V_TOTAL_CREDITOS_CLIENTES_ANUAL;
CREATE OR REPLACE SYNONYM MDY2131_P13_1.SYN_V_CLIENTES_PROD_INV FOR MDY2131_P13_1.V_CLIENTES_PROD_INV;
CREATE OR REPLACE SYNONYM MDY2131_P13_1.SYN_V_CLIENTES_CUMPLEANOS FOR MDY2131_P13_1.V_CLIENTES_CUMPLEANOS;
CREATE OR REPLACE SYNONYM MDY2131_P13_1.SYN_V_CLIENTES_CREDITOS_MAYORES FOR MDY2131_P13_1.V_CLIENTES_CREDITOS_MAYORES;
CREATE OR REPLACE SYNONYM MDY2131_P13_1.SYN_V_CLIENTES_SII_INV FOR MDY2131_P13_1.V_CLIENTES_SII_INV;

-- Creación de índices
CREATE INDEX idx_credito_cliente_fecha_solic_cred ON CREDITO_CLIENTE(fecha_solic_cred);

SELECT index_name
FROM user_indexes
WHERE table_name = 'CREDITO_CLIENTE'
AND index_name = 'IDX_CREDITO_CLIENTE_FECHA_SOLIC_CRED';

CREATE INDEX MDY2131_P13_1.idx_cliente_numrun_dvrun ON MDY2131_P13_1.cliente(numrun, dvrun);

SELECT index_name, table_name, column_name
FROM user_ind_columns
WHERE index_name = 'IDX_CLIENTE_NUMRUN_DVRUN';

-- Permiso de selección para usuario MDY2131_P13_2
GRANT SELECT ON MDY2131_P13_1.APORTE_A_SBIF TO MDY2131_P13_2;
GRANT SELECT ON MDY2131_P13_1.PRODUCTO_INVERSION TO MDY2131_P13_2;
GRANT SELECT ON MDY2131_P13_1.CREDITO TO MDY2131_P13_2;
GRANT SELECT ON MDY2131_P13_1.CREDITO_CLIENTE TO MDY2131_P13_2;
GRANT SELECT ON MDY2131_P13_1.V_CLIENTES_PROD_INV TO MDY2131_P13_2;

-- Usuario MDY2131_P13_4: Creación de sinónimos y permisos
CREATE SYNONYM MDY2131_P13_4.syn_cliente FOR MDY2131_P13_1.CLIENTE;
CREATE SYNONYM MDY2131_P13_4.syn_region FOR MDY2131_P13_1.REGION;
CREATE SYNONYM MDY2131_P13_4.syn_provincia FOR MDY2131_P13_1.PROVINCIA;
CREATE SYNONYM MDY2131_P13_4.syn_comuna FOR MDY2131_P13_1.COMUNA;
CREATE SYNONYM MDY2131_P13_4.syn_tipo_contrato FOR MDY2131_P13_1.TIPO_CONTRATO;
CREATE SYNONYM MDY2131_P13_4.syn_sucursal FOR MDY2131_P13_1.SUCURSAL;
CREATE SYNONYM MDY2131_P13_4.syn_tipo_movimiento FOR MDY2131_P13_1.TIPO_MOVIMIENTO;

GRANT SELECT ON MDY2131_P13_4.syn_tipo_movimiento TO MDY2131_P13_4;
GRANT SELECT ON MDY2131_P13_4.syn_sucursal TO MDY2131_P13_4;
GRANT SELECT ON MDY2131_P13_4.syn_tipo_contrato TO MDY2131_P13_4;
GRANT SELECT ON MDY2131_P13_4.syn_cliente TO MDY2131_P13_4;
GRANT SELECT ON MDY2131_P13_4.syn_region TO MDY2131_P13_4;
GRANT SELECT ON MDY2131_P13_4.syn_provincia TO MDY2131_P13_4;
GRANT SELECT ON MDY2131_P13_4.syn_comuna TO MDY2131_P13_4;

-- Usuario MDY2131_P13_5: Creación de sinónimos y permisos
CREATE SYNONYM MDY2131_P13_5.syn_cliente FOR MDY2131_P13_3.syn_cliente;
CREATE SYNONYM MDY2131_P13_5.syn_region FOR MDY2131_P13_3.syn_region;
CREATE SYNONYM MDY2131_P13_5.syn_provincia FOR MDY2131_P13_3.syn_provincia;
CREATE SYNONYM MDY2131_P13_5.syn_comuna FOR MDY2131_P13_3.syn_comuna;

GRANT SELECT ON MDY2131_P13_5.syn_cliente TO MDY2131_P13_5;
GRANT SELECT ON MDY2131_P13_5.syn_region TO MDY2131_P13_5;
GRANT SELECT ON MDY2131_P13_5.syn_provincia TO MDY2131_P13_5;
GRANT SELECT ON MDY2131_P13_5.syn_comuna TO MDY2131_P13_5;

-- Usuario MDY2131_P13_6: Creación de sinónimos y permisos
CREATE SYNONYM MDY2131_P13_6.syn_cliente FOR MDY2131_P13_3.syn_cliente;
CREATE SYNONYM MDY2131_P13_6.syn_region FOR MDY2131_P13_3.syn_region;
CREATE SYNONYM MDY2131_P13_6.syn_provincia FOR MDY2131_P13_3.syn_provincia;
CREATE SYNONYM MDY2131_P13_6.syn_comuna FOR MDY2131_P13_3.syn_comuna;

GRANT SELECT ON MDY2131_P13_6.syn_cliente TO MDY2131_P13_6;
GRANT SELECT ON MDY2131_P13_6.syn_region TO MDY2131_P13_6;
GRANT SELECT ON MDY2131_P13_6.syn_provincia TO MDY2131_P13_6;
GRANT SELECT ON MDY2131_P13_6.syn_comuna TO MDY2131_P13_6;

-- Creación de vistas para usuarios MDY2131_P13_5 y MDY2131_P13_6
CREATE OR REPLACE VIEW V_CLIENTE AS
SELECT * FROM CLIENTE;

CREATE OR REPLACE VIEW V_REGION AS
SELECT * FROM REGION;

CREATE OR REPLACE VIEW V_PROVINCIA AS
SELECT * FROM PROVINCIA;

CREATE OR REPLACE VIEW V_COMUNA AS
SELECT * FROM COMUNA;

GRANT SELECT ON V_CLIENTE TO MDY2131_P13_3;
GRANT SELECT ON V_REGION TO MDY2131_P13_3;
GRANT SELECT ON V_PROVINCIA TO MDY2131_P13_3;
GRANT SELECT ON V_COMUNA TO MDY2131_P13_3;

GRANT SELECT ON syn_cliente TO MDY2131_P13_5;
GRANT SELECT ON syn_region TO MDY2131_P13_5;
GRANT SELECT ON syn_provincia TO MDY2131_P13_5;
GRANT SELECT ON syn_comuna TO MDY2131_P13_5;

GRANT SELECT ON syn_cliente TO MDY2131_P13_6;
GRANT SELECT ON syn_region TO MDY2131_P13_6;
GRANT SELECT ON syn_provincia TO MDY2131_P13_6;
GRANT SELECT ON syn_comuna TO MDY2131_P13_6;

-- Creación de vistas para informes
CREATE OR REPLACE VIEW V_TOTAL_CREDITOS_CLIENTES_ANUAL AS
SELECT *
FROM MDY2131_P13_1.SYN_V_TOTAL_CREDITOS_CLIENTES_ANUAL;

CREATE OR REPLACE VIEW V_CLIENTES_PROD_INV AS
SELECT *
FROM MDY2131_P13_1.SYN_V_CLIENTES_PROD_INV;

CREATE OR REPLACE VIEW V_CLIENTES_CUMPLEANOS AS
SELECT *
FROM MDY2131_P13_1.SYN_V_CLIENTES_CUMPLEANOS;

CREATE OR REPLACE VIEW V_CLIENTES_SII_INV AS
SELECT *
FROM MDY2131_P13_1.SYN_V_CLIENTES_SII_INV;

GRANT SELECT ON V_TOTAL_CREDITOS_CLIENTES_ANUAL TO MDY2131_P13_5, MDY2131_P13_6;
GRANT SELECT ON V_CLIENTES_PROD_INV TO MDY2131_P13_5, MDY2131_P13_6;
GRANT SELECT ON V_CLIENTES_CUMPLEANOS TO MDY2131_P13_5, MDY2131_P13_6;
GRANT SELECT ON V_CLIENTES_SII_INV TO MDY2131_P13_5, MDY2131_P13_6;

COMMIT;

------------------------USUARIO 2---------------------------

-- Creación de informes
SELECT * FROM MDY2131_P13_1.V_TOTAL_CREDITOS_CLIENTES_ANUAL;
SELECT * FROM MDY2131_P13_1.V_CLIENTES_PROD_INV;
SELECT nro_cliente, pnombre, appaterno, apmaterno, fecha_nacimiento FROM MDY2131_P13_1.V_CLIENTES_CUMPLEANOS;
SELECT * FROM MDY2131_P13_1.V_CLIENTES_CREDITOS_MAYORES;
SELECT * FROM MDY2131_P13_1.V_CLIENTES_SII_INV;

-- Utilización de sinónimos
SELECT * FROM MDY2131_P13_1.SYN_V_TOTAL_CREDITOS_CLIENTES_ANUAL;
SELECT * FROM MDY2131_P13_1.SYN_V_CLIENTES_PROD_INV;
SELECT * FROM MDY2131_P13_1.SYN_V_CLIENTES_CUMPLEANOS;
SELECT * FROM MDY2131_P13_1.SYN_V_CLIENTES_CREDITOS_MAYORES;
SELECT * FROM MDY2131_P13_1.SYN_V_CLIENTES_SII_INV;

CREATE OR REPLACE VIEW MDY2131_P13_2.V_TOTAL_CREDITOS_CLIENTES_ANUAL AS
SELECT TO_CHAR(c.numrun) || '-' || UPPER(c.dvrun) AS RUN_CLIENTE,
       INITCAP(LOWER(c.pnombre)) || ' ' || INITCAP(LOWER(c.snombre)) || ' ' || INITCAP(LOWER(c.appaterno)) || ' ' || INITCAP(LOWER(c.apmaterno)) AS NOMBRE_CLIENTE,
       COUNT(cc.nro_cliente) AS TOTAL_CREDITOS_SOLICITADOS,
       TO_CHAR(SUM(cc.monto_solicitado), '$999G999G999') AS MONTO_TOTAL_CREDITO
FROM MDY2131_P13_1.cliente c 
JOIN MDY2131_P13_1.credito_cliente cc ON (c.nro_cliente = cc.nro_cliente)
WHERE EXTRACT(YEAR FROM cc.fecha_solic_cred) = EXTRACT(YEAR FROM SYSDATE) - 1
GROUP BY c.numrun, c.dvrun, c.pnombre, c.snombre, c.appaterno, c.apmaterno
ORDER BY c.appaterno;

SELECT index_name FROM user_indexes WHERE table_name = 'CREDITO_CLIENTE' AND index_name = 'IDX_CREDITO_CLIENTE_FECHA_SOLIC_CRED';
SELECT index_name, table_name, column_name FROM user_ind_columns WHERE index_name = 'IDX_CLIENTE_NUMRUN_DVRUN';

------------------------USUARIO 3---------------------------

-- Creación de informes
SELECT * FROM MDY2131_P13_1.V_TOTAL_CREDITOS_CLIENTES_ANUAL;
SELECT * FROM MDY2131_P13_1.V_CLIENTES_PROD_INV;
SELECT nro_cliente, pnombre, appaterno, apmaterno, fecha_nacimiento FROM MDY2131_P13_1.V_CLIENTES_CUMPLEANOS;
SELECT * FROM MDY2131_P13_1.V_CLIENTES_CREDITOS_MAYORES;
SELECT * FROM MDY2131_P13_1.V_CLIENTES_SII_INV;

-- Utilización de sinónimos
SELECT * FROM MDY2131_P13_1.SYN_V_TOTAL_CREDITOS_CLIENTES_ANUAL;
SELECT * FROM MDY2131_P13_1.SYN_V_CLIENTES_PROD_INV;
SELECT * FROM MDY2131_P13_1.SYN_V_CLIENTES_CUMPLEANOS;
SELECT * FROM MDY2131_P13_1.SYN_V_CLIENTES_CREDITOS_MAYORES;
SELECT * FROM MDY2131_P13_1.SYN_V_CLIENTES_SII_INV;

------------------------USUARIO 4---------------------------

-- Consultas sobre tablas usando sinónimos
SELECT * FROM MDY2131_P13_1.SYN_V_TOTAL_CREDITOS_CLIENTES_ANUAL;
SELECT * FROM MDY2131_P13_1.SYN_V_CLIENTES_PROD_INV;
SELECT * FROM MDY2131_P13_1.SYN_V_CLIENTES_CUMPLEANOS;
SELECT * FROM MDY2131_P13_1.SYN_V_CLIENTES_CREDITOS_MAYORES;
SELECT * FROM MDY2131_P13_1.SYN_V_CLIENTES_SII_INV;

SELECT * FROM MDY2131_P13_1.syn_aporte_a_sbif;
SELECT * FROM MDY2131_P13_1.syn_producto_inversion;
SELECT * FROM MDY2131_P13_1.syn_credito;
SELECT * FROM MDY2131_P13_1.syn_tipo_contrato;
SELECT * FROM MDY2131_P13_1.syn_region;
SELECT * FROM MDY2131_P13_1.syn_provincia;
SELECT * FROM MDY2131_P13_4.SYN_COMU;

------------------------USUARIO 5---------------------------

-- Permisos para tablas con sinónimos
SELECT * FROM MDY2131_P13_3.syn_cliente;
SELECT * FROM MDY2131_P13_3.syn_region;
SELECT * FROM MDY2131_P13_3.syn_provincia;
SELECT * FROM MDY2131_P13_3.syn_comuna;

-- Permiso para selección de informes con sinónimos
SELECT * FROM MDY2131_P13_1.SYN_V_TOTAL_CREDITOS_CLIENTES_ANUAL;
SELECT * FROM MDY2131_P13_1.SYN_V_CLIENTES_CUMPLEANOS;
SELECT * FROM MDY2131_P13_1.SYN_V_CLIENTES_SII_INV;

------------------------USUARIO 6---------------------------

-- Permisos para tablas con sinónimos de usuario 3
SELECT * FROM MDY2131_P13_3.syn_cliente;
SELECT * FROM MDY2131_P13_3.syn_region;
SELECT * FROM MDY2131_P13_3.syn_provincia;
SELECT * FROM MDY2131_P13_3.syn_comuna;

-- Selección de informes
SELECT * FROM MDY2131_P13_1.SYN_V_TOTAL_CREDITOS_CLIENTES_ANUAL;
SELECT * FROM MDY2131_P13_1.SYN_V_CLIENTES_CUMPLEANOS;
SELECT * FROM MDY2131_P13_1.SYN_V_CLIENTES_SII_INV;
